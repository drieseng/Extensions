<Project>
  <PropertyGroup>
    <BuildDependsOn Condition="'$(Configuration)' == 'Release' AND '$(OS)' == 'Windows_NT' AND $(PublishType.Contains('blob'))" >$(BuildDependsOn);PublishToProdCon</BuildDependsOn>
  </PropertyGroup>

  <Target Name="PublishToProdCon">
    <MSBuild Projects="$(MSBuildThisFileDirectory)..\eng\ProdConPublish.csproj"
             Targets="Restore"
             Properties="_Dummy=Restore" />

    <MSBuild Projects="$(MSBuildThisFileDirectory)..\eng\ProdConPublish.csproj"
             Targets="Publish"
             Properties="$(SolutionBuildProperties)" />
  </Target>

<!-- will move into korebuild -->
  <PropertyGroup>
    <DefaultHelixTestTimeout>00:30:00</DefaultHelixTestTimeout>
  </PropertyGroup>

  <Target Name="Helix">

    <PropertyGroup>
      <ProjectsToTestList>@(ProjectsToTest)</ProjectsToTestList>
    </PropertyGroup>

    <MSBuild Projects="$(MSBuildThisFileDirectory)..\test\helix.proj"
             Targets="Test"
             Properties="ProjectsToTest=$(ProjectsToTestList)"
             BuildInParallel="true" />

    <!--<PropertyGroup Condition="'$(WaitForHelix)' == ''">
      <WaitForHelix>false</WaitForHelix>
      <WaitForHelix Condition=" '$(CI)' == 'true' ">true</WaitForHelix>
    </PropertyGroup>

    <MSBuild Projects="@(ProjectsToTest)"
             Targets="CreateTestPayload"
             BuildInParallel="true">
      <Output TaskParameter="TargetOutputs" ItemName="TestPayload" />
    </MSBuild>

    <ItemGroup>
      <_TestPayloadItem Include="$(MSBuildThisFileDirectory)..\test\helix.proj">
        <AdditionalProperties>
          Version=11-1-$(Version);
          TestDirectory=%(TestPayload.Identity);
          TestName=%(TestPayload.TestName);
          TestCommand=%(TestPayload.Command);
          TestPlatform=%(TestPayload.TestPlatform);
        </AdditionalProperties>
      </_TestPayloadItem>
      <HelixJobs Include="%(TestPayload.Identity)" />
    </ItemGroup>

    <WriteLinesToFile
        File="$(MSBuildThisFileDirectory)..\test\helixJobs.props"
        Lines="@HelixJobs"
        Overwrite="true"
        Encoding="Unicode"/>
    
    <MSBuild Projects="@(_TestPayloadItem)"
             Targets="Test"
             Properties="WaitForWorkItemCompletion=$(WaitForHelix)"
             BuildInParallel="true" />-->
  </Target>

</Project>
